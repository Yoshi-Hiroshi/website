<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #status {
        color: #717171;
        text-align: center;
        margin: 20px 0;
    }
</style>

<div id="status"></div>
<div>
    <canvas id="myChart" style="height: 300px"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let myChart;
    let myChartData;
    let lastTimesJson;

    function init() {
        const labels = [];
        for (let i = 5; i < 24 + 5; i++) {
            const h = i % 24;
            for (let j = 0; j < 60; j += 15) {
                const m = j;
                labels.push(j > 0 ? '' : h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0'));
            }
        }

        myChartData = [];

        const data = {
            labels: labels,
            datasets: [{
                label: 'Pings',
                backgroundColor: '#78bb7b',
                borderColor: '#78bb7b',
                data: myChartData,
            }]
        };

        const config = {
            type: 'bar',
            data: data,
            options: {
                maintainAspectRatio: false,
            },
        };

        return new Chart(
            document.getElementById('myChart'),
            config,
        );
    }

    async function run() {
        const url = 'https://script.google.com/macros/s/AKfycbw6MiAhk_-juIaXqCillk5Ti4vI55nNDMykIJ3QHQEWNGpCKrRRCHOS3h5u5rNAvDvG/exec';
        const res = await fetch(url);
        const timesJson = await res.text();
        const times = JSON.parse(timesJson);

        const dateNow = new Date();
        const activeNow = times.filter(x => x > dateNow - 1000 * 60 * 5 && x <= dateNow).length >= 4;
        document.getElementById('status').innerHTML = activeNow ? (
            '<h1>ðŸŸ¢ Active</h1>'
        ) : (
            '<h1>ðŸ”´ Inactive</h1>'
        );

        if (timesJson === lastTimesJson) {
            return;
        }

        lastTimesJson = timesJson;

        myChartData.length = 0;
        let date = new Date();
        if (date.getHours() < 5) {
            date.setDate(date.getDate() - 1);
        }
        date.setHours(5, 0, 0, 0);
        for (let i = 5; i < 24 + 5; i++) {
            const h = i % 24;
            for (let j = 0; j < 60; j += 15) {
                const m = j;
                date.setMinutes(date.getMinutes() + 15);
                const active = times.filter(x => x > date - 1000 * 60 * 15 && x <= date).length;
                myChartData.push(active);
            }
        }

        myChart.update();
    }

    myChart = init();
    run();
    setInterval(run, 1000 * 60);
</script>
