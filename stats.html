<!DOCTYPE html>
<html>
<head>
<title>...</title>
<link rel="shortcut icon" href="https://github.com/favicon.ico">
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #status {
        color: #717171;
        text-align: center;
        margin: 20px 0;
    }

    #myChart {
        height: 300px;
    }
</style>
</head>
<body>
<h1 id="status">...</h1>
<div>
    <canvas id="myChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.2/dist/chartjs-plugin-annotation.min.js"></script>
<script>
(function () {
    'use strict';

    let myChart;
    let myChartAnnotation;
    let myChartData;

    // https://stackoverflow.com/a/29018745
    function binarySearch(ar, el) {
        let m = 0;
        let n = ar.length - 1;
        while (m <= n) {
            let k = (n + m) >> 1;
            if (el > ar[k]) {
                m = k + 1;
            } else if (el < ar[k]) {
                n = k - 1;
            } else {
                return k;
            }
        }
        return m;
    }

    function countInRange(ar, from, to) {
        return binarySearch(ar, to) - binarySearch(ar, from);
    }

    function init() {
        myChartAnnotation = {
            type: 'line',
            borderColor: '#717171',
            borderWidth: 1,
            scaleID: 'x',
            value: -1,
        };

        myChartData = [];
        const labels = [];
        for (let i = 5; i < 24 + 5; i++) {
            const h = i % 24;
            for (let j = 0; j < 60; j += 15) {
                const m = j;
                myChartData.push(0);
                labels.push(j > 0 ? '' : h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0'));
            }
        }

        const data = {
            labels: labels,
            datasets: [{
                label: 'Pings',
                backgroundColor: '#78bb7b',
                borderColor: '#78bb7b',
                data: myChartData,
            }]
        };

        const config = {
            type: 'bar',
            data: data,
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        suggestedMax: 15,
                    },
                },
                plugins: {
                    annotation: {
                        annotations: {
                            myChartAnnotation,
                        },
                    },
                },
            },
        };

        return new Chart(
            document.getElementById('myChart'),
            config,
        );
    }

    async function run() {
        const url = 'https://script.google.com/macros/s/AKfycbw6MiAhk_-juIaXqCillk5Ti4vI55nNDMykIJ3QHQEWNGpCKrRRCHOS3h5u5rNAvDvG/exec';
        const res = await fetch(url);
        const timesJson = await res.text();
        const times = JSON.parse(timesJson);

        const dateNow = new Date();
        const activeNow = countInRange(times, dateNow - 1000 * 60 * 5, dateNow) >= 4;
        const title = activeNow ? (
            'ðŸŸ¢ Active'
        ) : (
            'ðŸ”´ Inactive'
        );
        document.title = title;
        document.getElementById('status').textContent = title;

        let date = new Date();
        if (date.getHours() < 5) {
            date.setDate(date.getDate() - 1);
        }
        date.setHours(5, 0, 0, 0);
        let c = 0;
        for (let i = 5; i < 24 + 5; i++) {
            const h = i % 24;
            for (let j = 0; j < 60; j += 15) {
                const m = j;
                date.setMinutes(date.getMinutes() + 15);
                const active = countInRange(times, date - 1000 * 60 * 15, date);
                myChartData[c++] = active;
            }
        }

        myChartAnnotation.value = (((dateNow.getHours() + 24 - 5) % 24) * 60 + dateNow.getMinutes()) / 15;

        myChart.update();
    }

    myChart = init();
    run();
    setInterval(run, 1000 * 60);
})();
</script>
</body>
