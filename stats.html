<!DOCTYPE html>
<html>
<head>
<title>...</title>
<link rel="shortcut icon" href="https://github.com/favicon.ico">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    #status {
        color: #717171;
        text-align: center;
        margin: 20px 0;
    }

    #myChart {
        height: 300px;
    }

    #details {
        color: #717171;
        text-align: center;
        margin: 20px 0;
    }
</style>
</head>
<body>
<h1 id="status">...</h1>
<div>
    <canvas id="myChart"></canvas>
</div>
<div id="details">...</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.2.2/dist/chartjs-plugin-annotation.min.js"></script>
<script>
(function () {
    'use strict';

    let myChart;
    let myChartAnnotation;
    let myChartData;

    // https://stackoverflow.com/a/7641822
    // Takes an ISO time and returns a string representing how
    // long ago the date represents.
    function prettyDate(time) {
        var diff = (((new Date()).getTime() - time) / 1000),
            day_diff = Math.floor(diff / 86400);

        if (isNaN(day_diff) || day_diff < 0 || day_diff >= 31) return;

        return day_diff == 0 && (
            diff < 60 && "just now" || diff < 120 && "1 minute ago" || diff < 3600 && Math.floor(diff / 60) + " minutes ago" || diff < 7200 && "1 hour ago" || diff < 86400 && Math.floor(diff / 3600) + " hours ago") || day_diff == 1 && "Yesterday" || day_diff < 7 && day_diff + " days ago" || day_diff < 31 && Math.ceil(day_diff / 7) + " weeks ago";
    }

    // https://stackoverflow.com/a/29018745
    function binarySearch(ar, el) {
        let m = 0;
        let n = ar.length - 1;
        while (m <= n) {
            let k = (n + m) >> 1;
            if (el > ar[k]) {
                m = k + 1;
            } else if (el < ar[k]) {
                n = k - 1;
            } else {
                return k;
            }
        }
        return m;
    }

    function countInRange(ar, from, to) {
        return binarySearch(ar, to) - binarySearch(ar, from);
    }

    function init() {
        myChartAnnotation = {
            type: 'line',
            borderColor: '#717171',
            borderWidth: 1,
            scaleID: 'x',
            value: -1,
        };

        myChartData = [];
        const labels = [];
        for (let i = 5; i < 24 + 5; i++) {
            const h = i % 24;
            for (let j = 0; j < 60; j += 15) {
                const m = j;
                myChartData.push(0);
                labels.push(j > 0 ? '' : h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0'));
            }
        }

        const data = {
            labels: labels,
            datasets: [{
                label: 'Pings',
                backgroundColor: '#78bb7b',
                borderColor: '#78bb7b',
                data: myChartData,
            }]
        };

        const config = {
            type: 'bar',
            data: data,
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        suggestedMax: 15,
                    },
                },
                plugins: {
                    annotation: {
                        annotations: {
                            myChartAnnotation,
                        },
                    },
                },
            },
        };

        return new Chart(
            document.getElementById('myChart'),
            config,
        );
    }

    async function run() {
        const url = 'https://script.google.com/macros/s/AKfycbw6MiAhk_-juIaXqCillk5Ti4vI55nNDMykIJ3QHQEWNGpCKrRRCHOS3h5u5rNAvDvG/exec';
        const res = await fetch(url);
        const dataStr = await res.text();
        const data = JSON.parse(dataStr);
        const accessTimes = data.accessTimes;
        const lastAccessIp = data.lastAccessIp;

        const dateNow = new Date();
        const activeNow = countInRange(accessTimes,
            dateNow.valueOf() - 1000 * 60 * 5,
            dateNow.valueOf()) >= 4;
        const title = activeNow ? (
            'ðŸŸ¢ Active'
        ) : (
            'ðŸ”´ Inactive'
        );
        document.title = title;
        document.getElementById('status').textContent = title;

        let date = new Date();
        if (date.getHours() < 5) {
            date.setDate(date.getDate() - 1);
        }
        date.setHours(5, 0, 0, 0);
        let c = 0;
        for (let i = 5; i < 24 + 5; i++) {
            for (let j = 0; j < 60; j += 15) {
                const active = countInRange(accessTimes,
                    date.valueOf() - 1000 * 60 * 7.5,
                    date.valueOf() + 1000 * 60 * 7.5);
                myChartData[c++] = active;
                date.setMinutes(date.getMinutes() + 15);
            }
        }

        myChartAnnotation.value = (((dateNow.getHours() + 24 - 5) % 24) * 60 + dateNow.getMinutes()) / 15;

        myChart.update();

        document.getElementById('details').innerHTML = `
            Last IP: ${lastAccessIp.ip}<br>
            Updated: ${prettyDate(lastAccessIp.firstDate)}<br>
        `;

        const ipApiRes = await fetch('https://ipapi.co/' + lastAccessIp.ip + '/json/');
        const ipApiDataStr = await ipApiRes.text();
        const ipApiData = JSON.parse(ipApiDataStr);

/*
    "ip": "2a0d:6fc2:5013:c800:6c7a:2294:61f3:6e04",
    "version": "IPv6",
    "city": "Tel Aviv",
    "region": "Tel Aviv",
    "region_code": "TA",
    "country": "IL",
    "country_name": "Israel",
    "country_code": "IL",
    "country_code_iso3": "ISR",
    "country_capital": "Jerusalem",
    "country_tld": ".il",
    "continent_code": "AS",
    "in_eu": false,
    "postal": null,
    "latitude": 32.0668,
    "longitude": 34.7649,
    "timezone": "Asia/Jerusalem",
    "utc_offset": "+0200",
    "country_calling_code": "+972",
    "currency": "ILS",
    "currency_name": "Shekel",
    "languages": "he,ar-IL,en-IL,",
    "country_area": 20770.0,
    "country_population": 8883800,
    "asn": "AS12400",
    "org": "Partner Communications Ltd."
*/

        let newDetailsInnerHtml = document.getElementById('details');
        for (const [key, value] of Object.entries(ipApiData)) {
            if (![
                'ip',
                'version',
                //'city',
                //'region',
                'region_code',
                'country',
                //'country_name',
                'country_code',
                'country_code_iso3',
                'country_capital',
                'country_tld',
                'continent_code',
                'in_eu',
                //'postal',
                'latitude',
                'longitude',
                'timezone',
                'utc_offset',
                'country_calling_code',
                'currency',
                'currency_name',
                'languages',
                'country_area',
                'country_population',
                'asn',
                //'org',  
            ].includes(key) && value) {
                newDetailsInnerHtml += `${key}: ${value}<br>\n`;
            }
        }

        document.getElementById('details').innerHTML += newDetailsInnerHtml;
    }

    myChart = init();
    run();
    setInterval(run, 1000 * 60);
})();
</script>
</body>
